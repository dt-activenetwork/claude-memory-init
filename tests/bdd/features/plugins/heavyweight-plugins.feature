# language: zh-CN
功能: 重型插件初始化
  作为一个使用 Claude Init 的开发者
  我希望能够使用重型插件（如 Claude Flow）
  以便获得高级的 AI 辅助开发功能

  背景:
    假如 一个新的空项目目录

  # ============== 重型插件初始化场景 ==============

  场景: 标准模式初始化重型插件
    当 用户选择 "claude-flow" 插件
    并且 用户选择 "standard" 初始化模式
    并且 用户确认初始化
    那么 重型插件应该成功初始化
    并且 初始化命令应该被执行

  场景: SPARC 模式初始化重型插件
    当 用户选择 "claude-flow" 插件
    并且 用户选择 "sparc" 初始化模式
    并且 用户确认初始化
    那么 重型插件应该成功初始化
    并且 应该包含 SPARC 工作流配置

  场景: 最小模式初始化重型插件
    当 用户选择 "claude-flow" 插件
    并且 用户选择 "minimal" 初始化模式
    并且 用户确认初始化
    那么 重型插件应该成功初始化
    并且 应该跳过工作流选择

  场景: 跳过重型插件初始化
    当 用户选择 "claude-flow" 插件
    并且 用户选择 "skip" 初始化模式
    那么 重型插件应该被禁用
    并且 不应该执行初始化命令

  # ============== 文件保护和合并场景 ==============

  @skip
  场景: 保护现有 CLAUDE.md 文件
    # 注意：此场景需要完整的初始化流程，在 BDD 测试中跳过
    # 该功能已在单元测试和集成测试中覆盖
    假如 项目中存在 "CLAUDE.md" 文件包含 "# Existing Content"
    当 用户选择 "claude-flow" 插件
    并且 用户选择 "standard" 初始化模式
    那么 重型插件应该成功初始化

  场景: 合并策略 - append
    假如 项目中存在 "CLAUDE.md" 文件包含 "# Our Content"
    当 重型插件生成 "CLAUDE.md" 文件包含 "# Their Content"
    并且 合并策略为 "append"
    那么 合并后文件应该先包含 "# Our Content"
    并且 合并后文件应该后包含 "# Their Content"

  场景: 合并策略 - prepend
    假如 项目中存在 "CLAUDE.md" 文件包含 "# Our Content"
    当 重型插件生成 "CLAUDE.md" 文件包含 "# Their Content"
    并且 合并策略为 "prepend"
    那么 合并后文件应该先包含 "# Their Content"
    并且 合并后文件应该后包含 "# Our Content"

  场景: 合并策略 - custom
    假如 项目中存在 "config.toon" 文件包含原始配置
    当 重型插件生成 "config.toon" 文件包含新配置
    并且 合并策略为 "custom"
    那么 应该使用插件的自定义合并函数

  # ============== 冲突解决场景 ==============

  场景: 检测插件互斥冲突
    假如 插件 "claude-flow" 与 "task-system" 冲突
    当 用户同时选择 "claude-flow" 和 "task-system"
    那么 应该显示冲突警告
    并且 应该移除冲突的插件

  场景: 重型插件优先级
    假如 用户选择了多个插件，包括重型和轻型插件
    当 初始化开始
    那么 轻型插件应该先执行
    并且 重型插件应该后执行

  # ============== 错误恢复场景 ==============

  场景: 命令执行失败时恢复
    假如 项目中存在 "CLAUDE.md" 文件包含 "# Original"
    当 重型插件初始化命令失败
    那么 应该恢复原始文件
    并且 文件 "CLAUDE.md" 应该包含 "# Original"

  场景: 命令超时处理
    当 重型插件初始化命令超时
    那么 应该终止命令
    并且 应该恢复备份文件

  场景: 部分文件合并失败
    假如 项目中存在多个受保护文件
    当 其中一个文件合并失败
    那么 应该记录失败的文件
    并且 应该继续处理其他文件

  # ============== MCP 配置场景 ==============

  场景: 配置 MCP 服务器
    当 用户选择 "claude-flow" 插件
    并且 用户选择 MCP 服务器: "filesystem,memory"
    那么 MCP 配置应该包含所选服务器

  场景: 合并现有 MCP 配置
    假如 Claude 配置中已存在 MCP 服务器
    当 重型插件添加新的 MCP 服务器
    那么 应该保留现有服务器
    并且 应该添加新服务器

  # ============== 分离插件场景 ==============

  场景: 正确分离轻型和重型插件
    假如 有以下插件:
      | 名称             | 类型     |
      | system-detector | 轻型     |
      | memory-system   | 轻型     |
      | claude-flow     | 重型     |
    当 分离插件
    那么 轻型插件列表应该包含 "system-detector" 和 "memory-system"
    并且 重型插件列表应该只包含 "claude-flow"
