# Plugin Prompt Specification

**Version:** 1.0.0
**Date:** 2025-01-18
**Status:** Design Complete

---

## Overview

This document defines how plugins contribute content to the generated `CLAUDE.md` file in the v2.0 plugin-based architecture. Instead of a single monolithic template, `CLAUDE.md` is now dynamically assembled from prompt sections contributed by individual plugins.

### Key Principles

1. **Modular Composition**: Each plugin contributes an independent section
2. **Conditional Generation**: Sections only appear if the plugin is enabled
3. **Priority-Based Ordering**: Sections are ordered by plugin priority
4. **Variable Substitution**: Templates support variable interpolation and conditional blocks
5. **Extensibility**: New plugins can easily add prompt sections

---

## CLAUDE.md Overall Structure

The final `CLAUDE.md` is assembled from multiple sections in this order:

```markdown
# Project: {project_name}

{project_description}

---

## System Information
[Generated by system-detector plugin - priority 10]

---

## Git Operations
[Generated by git plugin - priority 20]

---

## Memory System
[Generated by memory-system plugin - priority 30]

---

## Prompt Presets
[Generated by prompt-presets plugin - priority 40]

---

## Custom Instructions
[User-editable section - not managed by plugins]
```

### Section Ordering

Sections are ordered by plugin priority (ascending):

| Priority | Plugin | Section Title |
|----------|--------|---------------|
| 10 | system-detector | System Information |
| 20 | git | Git Operations |
| 30 | memory-system | Memory System |
| 40 | prompt-presets | Prompt Presets |
| 100+ | custom | User-defined sections |

---

## Plugin Prompt Specifications

### System Detector Plugin

**Priority:** 10
**Section Title:** System Information
**Always Generated:** Yes (if plugin enabled)

#### Content Template

```markdown
## System Information

**Operating System**: {{system.os_name}} ({{system.os_version}})
{{#if system.os_type}}
**OS Type**: {{system.os_type}}
{{/if}}

**Package Manager**: {{system.package_manager}}
{{#if system.install_prefix}}
**Install Prefix**: {{system.install_prefix}}
{{/if}}

### Package Installation

When installing system packages or dependencies:

\```bash
{{system.install_command_example}}
\```

**Important Notes**:
- Use `{{system.package_manager}}` for package installation
{{#if system.has_sudo}}
- Sudo is available for privileged operations
{{/if}}
{{#unless system.is_root}}
- Running as non-root user
{{/unless}}

---

## Development Environment

{{#if dev_tools.python.available}}
### Python Development

**Version**: {{dev_tools.python.version}}
**Package Manager**: {{dev_tools.python.package_manager}}
{{#if dev_tools.python.venv_path}}
**Virtual Environment**: {{dev_tools.python.venv_path}}
{{/if}}

**Guidelines**:
- Use {{dev_tools.python.package_manager}} for package management
- Follow Python {{dev_tools.python.version}} syntax and features
{{#if dev_tools.python.venv_path}}
- Virtual environment is already configured
{{else}}
- Consider creating a virtual environment for isolation
{{/if}}
{{/if}}

{{#if dev_tools.node.available}}
### Node.js Development

**Version**: {{dev_tools.node.version}}
**Package Manager**: {{dev_tools.node.package_manager}}

**Guidelines**:
- Use {{dev_tools.node.package_manager}} for package management
- Use `{{dev_tools.node.run_command}}` to run scripts
- Follow Node.js {{dev_tools.node.version}} APIs
{{/if}}

{{#unless dev_tools.python.available}}
{{#unless dev_tools.node.available}}
**Note**: No Python or Node.js environment detected. If needed, install development tools using the system package manager.
{{/unless}}
{{/unless}}
```

#### Variables

| Variable | Type | Description | Example |
|----------|------|-------------|---------|
| `system.os_name` | string | OS name | "Ubuntu", "macOS", "Windows" |
| `system.os_version` | string | OS version | "22.04", "14.2", "11" |
| `system.os_type` | string? | OS type | "Linux", "Darwin", "MSYS2" |
| `system.package_manager` | string | Package manager | "apt", "brew", "pacman" |
| `system.install_prefix` | string? | Install prefix | "sudo" or "" |
| `system.install_command_example` | string | Example command | "sudo apt install <package>" |
| `system.has_sudo` | boolean | Sudo available | true/false |
| `system.is_root` | boolean | Running as root | true/false |
| `dev_tools.python.available` | boolean | Python detected | true/false |
| `dev_tools.python.version` | string? | Python version | "3.11.5" |
| `dev_tools.python.package_manager` | string? | Python pkg manager | "pip", "uv", "poetry" |
| `dev_tools.python.venv_path` | string? | Venv path | ".venv" or null |
| `dev_tools.node.available` | boolean | Node detected | true/false |
| `dev_tools.node.version` | string? | Node version | "20.10.0" |
| `dev_tools.node.package_manager` | string? | Node pkg manager | "npm", "pnpm", "yarn" |
| `dev_tools.node.run_command` | string? | Run command | "npm run", "pnpm" |

---

### Git Plugin

**Priority:** 20
**Section Title:** Git Operations
**Conditional Generation:** Only if git plugin enabled

#### Content Template

```markdown
## Git Operations

{{#if git.enabled}}
{{#if git.auto_commit}}
### Auto-Commit Configuration

**Status**: ENABLED

Changes to Claude memory system files will be automatically committed after initialization.

{{#if git.commit_separately}}
- Memory system files (`claude/` directory) are committed **separately** from other changes
- This keeps memory updates isolated and easier to review
{{else}}
- Memory system files are committed **together** with other changes
- Single commit includes all modifications
{{/if}}

**Commit Message Format**:
```
chore: update memory system (config, prompts, memory)

Update Claude memory system configuration and files.

Date: YYYY-MM-DD
Files updated: N

Auto-generated commit by claude-memory-init.
```
{{else}}
### Auto-Commit Configuration

**Status**: DISABLED

Memory system files will not be automatically committed. You must commit changes manually.
{{/if}}

{{#if git.remote_sync.enabled}}
### Remote Sync Configuration

**Status**: ENABLED

**Repository**: {{git.remote_sync.remote_url}}

System memory files can be synced to the remote repository.

{{#if git.remote_sync.auto_pr}}
- **Auto PR**: ENABLED - Pull requests are automatically created when syncing changes
- **PR Label**: `{{git.remote_sync.pr_label}}`
{{else}}
- **Auto PR**: DISABLED - You must create pull requests manually
{{/if}}

**Synced Files**: Only `memory/system/` files (team-shared knowledge)
**Excluded**: `memory/semantic/`, `memory/episodic/`, `memory/procedural/` (project-specific)
{{else}}
### Remote Sync Configuration

**Status**: DISABLED

Remote sync is not configured. System memory files remain local only.
{{/if}}

### Git Ignore Configuration

The following patterns are automatically added to `.gitignore`:

{{#each git.ignore_patterns}}
- `{{this}}`
{{/each}}

---

### Git Rules for AI Agent

{{#if git.ai_git_operations}}
**AI Git Operations**: ENABLED

The AI Agent is permitted to perform git operations within these constraints:

- ‚úÖ Create commits with descriptive messages
- ‚úÖ Stage files for commit
- ‚úÖ Push to remote branches
- ‚ùå **NEVER** use `--force` flags
- ‚ùå **NEVER** perform hard resets
- ‚ùå **NEVER** amend commits from other authors
- ‚ùå **ALWAYS** check authorship before amending: `git log -1 --format='%an %ae'`

{{#if git.auto_commit}}
**Note**: Auto-commit is enabled, so most git operations are handled automatically.
{{/if}}
{{else}}
**AI Git Operations**: DISABLED

üö´ **ABSOLUTE PROHIBITION**: The AI Agent is **FORBIDDEN** from performing ANY git operations.

- ‚ùå No git commands (commit, push, pull, merge, rebase, etc.)
- ‚ùå No commit message generation
- ‚ùå No staging files with `git add`
- ‚ùå No suggestions to run git commands

**Rationale**: Version control is EXCLUSIVELY the user's responsibility.

When work is complete:
1. ‚úÖ Inform user: "Work complete. Files have been created/updated."
2. ‚úÖ List affected files
3. ‚ùå **DO NOT** offer to commit or suggest git commands

**The user will handle all git operations themselves.**
{{/if}}
{{else}}
## Git Integration

**Status**: Not configured

Git integration is disabled for this project.
{{/if}}
```

#### Variables

| Variable | Type | Description | Example |
|----------|------|-------------|---------|
| `git.enabled` | boolean | Git plugin enabled | true/false |
| `git.auto_commit` | boolean | Auto-commit enabled | true/false |
| `git.commit_separately` | boolean | Separate commits | true/false |
| `git.ignore_patterns` | string[] | Gitignore patterns | ["claude/temp/"] |
| `git.remote_sync.enabled` | boolean | Remote sync enabled | true/false |
| `git.remote_sync.remote_url` | string? | Remote URL | "git@github.com:..." |
| `git.remote_sync.auto_pr` | boolean? | Auto PR | true/false |
| `git.remote_sync.pr_label` | string? | PR label | "system-prompt-update" |
| `git.ai_git_operations` | boolean | AI can use git | true/false |

---

### Memory System Plugin

**Priority:** 30
**Section Title:** Memory System
**Always Generated:** Yes (if plugin enabled)

#### Content Template

```markdown
## Memory System

This project uses Claude's memory system to maintain context and knowledge across sessions through a structured memory architecture.

### Memory Types Enabled

{{#each memory.memory_types}}
- **{{@key}}**: {{this.description}}
{{/each}}

### Memory Structure

```
{{project.name}}/
‚îú‚îÄ‚îÄ {{paths.base_dir}}/
‚îÇ   ‚îú‚îÄ‚îÄ memory/
{{#if memory.memory_types.semantic}}
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ semantic/          # Stable knowledge and concepts
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ sem-NNN-*.md
{{/if}}
{{#if memory.memory_types.episodic}}
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ episodic/          # Task history and temporal context
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ep-NNN-*.md
{{/if}}
{{#if memory.memory_types.procedural}}
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ procedural/        # Workflows and procedures
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ proc-*.md
{{/if}}
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ system/            # Team-shared templates and tools
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ tools/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index/             # Global indexes
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ tags.json
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ topics.json
```

### Memory-First Operating Principle

**MANDATORY WORKFLOW**: Every action must follow this sequence:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ PHASE 1: CONSULT MEMORY (BEFORE work)     ‚îÇ
‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ‚îÇ
‚îÇ 1. Read tags.json and topics.json         ‚îÇ
‚îÇ 2. Query for relevant knowledge           ‚îÇ
‚îÇ 3. Read semantic notes (stable knowledge) ‚îÇ
‚îÇ 4. Read episodic notes (history)          ‚îÇ
‚îÇ 5. Read procedural notes (workflows)      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
               ‚îÇ
               ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ PHASE 2: WORK (WITH memory as foundation) ‚îÇ
‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ‚îÇ
‚îÇ ‚úÖ Use memory knowledge as base           ‚îÇ
‚îÇ ‚úÖ Only read NEW code if memory lacking   ‚îÇ
‚îÇ ‚úÖ Create notes IMMEDIATELY on discovery  ‚îÇ
‚îÇ ‚ùå NEVER re-analyze what's in memory      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
               ‚îÇ
               ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ PHASE 3: UPDATE MEMORY (AFTER actions)    ‚îÇ
‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ‚îÇ
‚îÇ 1. Create/update semantic notes           ‚îÇ
‚îÇ 2. Create/update episodic notes           ‚îÇ
‚îÇ 3. Update indexes IMMEDIATELY             ‚îÇ
‚îÇ 4. Add cross-references                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Session Start Checklist

**ALWAYS do these at session start**:
- [ ] Read `/{{paths.base_dir}}/memory/index/tags.json`
- [ ] Read `/{{paths.base_dir}}/memory/index/topics.json`
{{#if memory.memory_types.episodic}}
- [ ] Read last 1-2 episodic notes
{{/if}}
{{#if memory.memory_types.semantic}}
- [ ] Query and read relevant semantic notes
{{/if}}
{{#if memory.memory_types.procedural}}
- [ ] Check for workflow procedures if task-specific
{{/if}}

### Memory File Formats

{{#if memory.memory_types.semantic}}
**Semantic Memory**:
```markdown
---
id: sem-NNN
tags: [concept, architecture, api]
topics: [backend, database]
created: YYYY-MM-DD
updated: YYYY-MM-DD
---

# [Concept Name]

## Overview
[Stable, factual knowledge about this concept]

## Details
[Key facts, relationships, dependencies]

## References
- Related: [[sem-XXX]], [[sem-YYY]]
- Outputs: [[result/N/file.md#section]]
```
{{/if}}

{{#if memory.memory_types.episodic}}
**Episodic Memory**:
```markdown
---
id: ep-NNN
date: YYYYMMDD
task: N
tags: [task-N, implementation, testing]
topics: [feature-X]
---

# Task N: [Task Name] - [Phase]

## Session Context
- **Started**: [timestamp]
- **Duration**: [time]
- **Phase**: [Planning/Implementation/Testing]

## Actions Taken
1. [What was done]
2. [Decisions made]

## Outcomes
- Files modified: [list]
- Key insights: [discoveries]

## Next Steps
- [ ] [What remains to be done]

## Cross-References
- Semantic: [[sem-XXX]]
- Outputs: [[result/N/output.md]]
```
{{/if}}

{{#if memory.memory_types.procedural}}
**Procedural Memory**:
```markdown
---
id: proc-[name]
category: workflow
tags: [procedure, testing, deployment]
---

# [Workflow Name]

## When to Use
[Trigger conditions for this workflow]

## Steps
1. [Step 1]
2. [Step 2]
3. [Step 3]

## Inputs
- [Required inputs]

## Outputs
- [Expected outputs]

## Checkpoints
- [ ] [Critical validation points]
```
{{/if}}

### Context Overflow Prevention

**CRITICAL**: Monitor context usage to prevent overflow.

- **Context >70%**: Prepare for checkpointing
- **Context >80%**: Checkpoint NOW

**Checkpointing Protocol**:
1. PAUSE current work immediately
2. Save ALL progress to episodic note
3. Update all indexes
4. Create "resume plan"
5. Inform user: "‚ö†Ô∏è Context at XX%. Saved to memory. Please run: /clear"
6. After /clear: Resume from checkpoint

### Memory Template Source

{{#if memory.template_source_type}}
**Template**: {{memory.template_source_type}}
{{#if memory.template_source_url}}
**URL**: {{memory.template_source_url}}
{{/if}}
{{#if memory.template_source_path}}
**Path**: {{memory.template_source_path}}
{{/if}}
{{/if}}

For complete memory system documentation, see:
- `/{{paths.base_dir}}/memory/DESIGN.md` - Architecture and design
- `/{{paths.base_dir}}/memory/procedural/memory-first-workflow.md` - Detailed workflows
- `/{{paths.base_dir}}/memory/procedural/memory-system-operations.md` - Operations guide
```

#### Variables

| Variable | Type | Description | Example |
|----------|------|-------------|---------|
| `memory.memory_types` | object | Enabled memory types | {semantic: {...}, episodic: {...}} |
| `memory.memory_types.*.description` | string | Type description | "Stable knowledge" |
| `memory.template_source_type` | string? | Template type | "default", "git", "local" |
| `memory.template_source_url` | string? | Git URL | "git@github.com:..." |
| `memory.template_source_path` | string? | Local path | "./templates/memory" |
| `paths.base_dir` | string | Base directory | "claude" |
| `project.name` | string | Project name | "My Project" |

**Memory Types Object Structure**:
```typescript
{
  semantic: {
    enabled: boolean,
    description: string,
    directory: string
  },
  episodic: {
    enabled: boolean,
    description: string,
    directory: string
  },
  procedural: {
    enabled: boolean,
    description: string,
    directory: string
  }
}
```

---

### Prompt Presets Plugin

**Priority:** 40
**Section Title:** Prompt Presets
**Conditional Generation:** Only if presets are selected

#### Content Template

```markdown
## Prompt Presets

This project has installed prompt presets for common development tasks. Each preset provides specialized instructions and guidelines.

### Installed Presets

{{#each presets.installed}}
- **[{{this.name}}]({{../paths.base_dir}}/prompts/{{this.filename}})**: {{this.description}}
{{/each}}

### Usage Guidelines

**When to use presets**:
- User explicitly requests the task (e.g., "Review this code", "Generate documentation")
- Task aligns with preset's scope and purpose

**How to use presets**:
1. User mentions task or preset name
2. Read the preset file: `/{{paths.base_dir}}/prompts/{{preset-filename}}.md`
3. Follow the instructions and guidelines in the preset
4. Apply preset-specific formatting and quality standards

**Available preset categories**:
{{#each presets.categories}}
- **{{@key}}**: {{this.description}}
  {{#each this.presets}}
  - {{this}}
  {{/each}}
{{/each}}

{{#if presets.allow_custom}}
### Custom Presets

Custom preset templates are enabled in this project.

**Location**: `/{{paths.base_dir}}/prompts/custom/`

Users can add their own prompt templates to this directory. Follow the same format as built-in presets.
{{/if}}

### Preset File Format

Each preset follows this structure:

```markdown
---
name: [Preset Name]
category: [Category]
version: 1.0.0
---

# [Preset Name]

## Purpose
[What this preset is for]

## When to Use
[Specific scenarios and triggers]

## Guidelines
[Detailed instructions]

## Output Format
[Expected output structure]

## Examples
[Concrete examples]
```

**Note**: Presets are guidelines, not rigid rules. Adapt to specific context and user needs while maintaining quality standards.
```

#### Variables

| Variable | Type | Description | Example |
|----------|------|-------------|---------|
| `presets.installed` | array | Installed presets | [{name, filename, description}] |
| `presets.installed[].name` | string | Preset name | "Code Review" |
| `presets.installed[].filename` | string | File name | "code-review" |
| `presets.installed[].description` | string | Description | "Guidelines for code review" |
| `presets.categories` | object | Preset categories | {development: {...}, documentation: {...}} |
| `presets.categories.*.description` | string | Category desc | "Development tasks" |
| `presets.categories.*.presets` | string[] | Preset names | ["Code Review", "Testing"] |
| `presets.allow_custom` | boolean | Custom presets | true/false |
| `paths.base_dir` | string | Base directory | "claude" |

**Installed Preset Object**:
```typescript
{
  name: string,        // Display name
  filename: string,    // File name without extension
  description: string, // Short description
  category: string     // Category name
}
```

**Categories Object**:
```typescript
{
  development: {
    description: "Development and coding tasks",
    presets: ["Code Review", "Refactoring", "Testing"]
  },
  documentation: {
    description: "Documentation tasks",
    presets: ["Documentation", "Architecture"]
  },
  debugging: {
    description: "Debugging and troubleshooting",
    presets: ["Bug Fixing"]
  }
}
```

---

## Plugin Prompt API

### TypeScript Interface

```typescript
/**
 * Plugin prompt contribution interface
 */
export interface PluginPromptContributor {
  /**
   * Generate the prompt content for this plugin
   *
   * @param config - Plugin configuration from user
   * @param context - Shared context (project info, other plugins)
   * @returns Rendered markdown content for CLAUDE.md
   */
  generatePrompt(
    config: PluginConfig,
    context: PromptGenerationContext
  ): Promise<string>;

  /**
   * Section identifier (used for ordering and debugging)
   */
  sectionId: string;

  /**
   * Section title (appears as ## heading in CLAUDE.md)
   */
  sectionTitle: string;

  /**
   * Priority for ordering (lower = earlier in file)
   * Recommended ranges:
   * - 10: System/environment info
   * - 20: Tool configurations (git, etc.)
   * - 30: Core features (memory system)
   * - 40: Optional features (presets, etc.)
   * - 100+: User-defined sections
   */
  priority: number;
}

/**
 * Context available during prompt generation
 */
export interface PromptGenerationContext {
  /** Project information */
  project: {
    name: string;
    description: string;
  };

  /** Path configuration */
  paths: {
    base_dir: string;
    codebase: string;
  };

  /** Language configuration */
  language: {
    user_language: string;
    think_language: string;
  };

  /** Other plugins' configurations (for cross-plugin awareness) */
  otherPlugins: Map<string, PluginConfig>;

  /** Template rendering engine */
  templateEngine: TemplateEngine;
}

/**
 * Template engine interface
 */
export interface TemplateEngine {
  /**
   * Render template with variables and conditional blocks
   */
  render(template: string, variables: Record<string, any>): string;
}
```

### Integration into Plugin Interface

```typescript
export interface Plugin {
  meta: {
    name: string;
    commandName: string;
    version: string;
    description: string;
    recommended?: boolean;
  };

  /** Plugin configuration flow (optional) */
  configuration?: PluginConfigurationFlow;

  /** Plugin lifecycle hooks (optional) */
  hooks?: PluginHooks;

  /** Plugin commands (optional) */
  commands?: PluginCommand[];

  /** üî• NEW: Prompt contribution (optional) */
  prompt?: PluginPromptContributor;
}
```

### Example Implementation

```typescript
// plugins/system-detector/prompt.ts

export const systemDetectorPrompt: PluginPromptContributor = {
  sectionId: 'system-information',
  sectionTitle: 'System Information',
  priority: 10,

  generatePrompt: async (config, context) => {
    const { templateEngine } = context;

    // Load template
    const template = await loadTemplate('system-info.md.template');

    // Prepare variables
    const variables = {
      system: config.options.system_info,
      dev_tools: config.options.dev_tools,
      paths: context.paths
    };

    // Render template
    return templateEngine.render(template, variables);
  }
};

// plugins/system-detector/index.ts

export const systemDetectorPlugin: Plugin = {
  meta: {
    name: 'system-detector',
    commandName: 'system',
    version: '1.0.0',
    description: 'Detect OS and development tools',
    recommended: true
  },

  configuration: {
    // ... configuration flow
  },

  hooks: {
    // ... lifecycle hooks
  },

  // üî• Provide prompt contribution
  prompt: systemDetectorPrompt
};
```

---

## Template Variable System

### Variable Naming Convention

**Format**: `{category}.{subcategory}.{property}`

**Examples**:
- `project.name` - Project name
- `system.os_name` - Operating system name
- `git.auto_commit` - Git auto-commit setting
- `memory.memory_types.semantic.enabled` - Semantic memory enabled

**Rules**:
1. Use lowercase with underscores: `os_name` (not `osName` or `os-name`)
2. Use dots for hierarchy: `system.os.name` (not `system_os_name`)
3. Boolean values: `enabled`, `available`, `is_root`, `has_sudo`
4. Paths: end with `_path`, `_dir`, `_url`
5. Lists: use plural: `ignore_patterns`, `memory_types`

### Conditional Block Syntax

We use Handlebars-style syntax for conditional blocks and iteration:

#### If/Else Blocks

```handlebars
{{#if condition}}
  Content when condition is true
{{else}}
  Content when condition is false
{{/if}}

{{#unless condition}}
  Content when condition is false
{{/unless}}
```

#### Iteration

```handlebars
{{#each items}}
  - Item: {{this}}
  - Index: {{@index}}
  - Key: {{@key}}
{{/each}}
```

#### Nested Access

```handlebars
{{object.nested.property}}
{{array.[0].property}}
```

### Complete Variable Registry

#### Project Variables

```typescript
{
  project: {
    name: string,              // Project name
    description: string,       // Project description
    type: string?              // Project type (optional)
  }
}
```

#### Path Variables

```typescript
{
  paths: {
    base_dir: string,          // Base directory (e.g., "claude")
    codebase: string           // Codebase root path
  }
}
```

#### Language Variables

```typescript
{
  language: {
    user_language: string,     // User-facing language
    think_language: string     // Internal reasoning language
  }
}
```

#### System Variables (system-detector plugin)

```typescript
{
  system: {
    os_name: string,                // "Ubuntu", "macOS", "Windows"
    os_version: string,             // "22.04", "14.2", "11"
    os_type: string?,               // "Linux", "Darwin", "MSYS2"
    package_manager: string,        // "apt", "brew", "pacman"
    install_prefix: string?,        // "sudo" or ""
    install_command_example: string,// "sudo apt install <package>"
    has_sudo: boolean,              // Sudo available
    is_root: boolean                // Running as root
  },
  dev_tools: {
    python: {
      available: boolean,
      version: string?,
      package_manager: string?,   // "pip", "uv", "poetry"
      venv_path: string?
    },
    node: {
      available: boolean,
      version: string?,
      package_manager: string?,   // "npm", "pnpm", "yarn"
      run_command: string?        // "npm run", "pnpm"
    }
  }
}
```

#### Git Variables (git plugin)

```typescript
{
  git: {
    enabled: boolean,
    auto_commit: boolean,
    commit_separately: boolean,
    ignore_patterns: string[],
    remote_sync: {
      enabled: boolean,
      remote_url: string?,
      auto_pr: boolean?,
      pr_label: string?
    },
    ai_git_operations: boolean
  }
}
```

#### Memory Variables (memory-system plugin)

```typescript
{
  memory: {
    memory_types: {
      semantic?: {
        enabled: boolean,
        description: string,
        directory: string
      },
      episodic?: {
        enabled: boolean,
        description: string,
        directory: string
      },
      procedural?: {
        enabled: boolean,
        description: string,
        directory: string
      }
    },
    template_source_type: string?,  // "default", "git", "local"
    template_source_url: string?,
    template_source_path: string?
  }
}
```

#### Preset Variables (prompt-presets plugin)

```typescript
{
  presets: {
    installed: Array<{
      name: string,
      filename: string,
      description: string,
      category: string
    }>,
    categories: {
      [categoryName: string]: {
        description: string,
        presets: string[]
      }
    },
    allow_custom: boolean
  }
}
```

---

## CLAUDE.md Generation Flow

### Algorithm

```typescript
/**
 * Generate CLAUDE.md from plugin contributions
 */
async function generateCLAUDEmd(
  projectInfo: ProjectInfo,
  enabledPlugins: Plugin[],
  pluginConfigs: Map<string, PluginConfig>
): Promise<string> {
  // 1. Collect prompt contributions from plugins
  const sections: Array<{
    sectionId: string;
    sectionTitle: string;
    content: string;
    priority: number;
  }> = [];

  const context: PromptGenerationContext = {
    project: projectInfo,
    paths: projectInfo.paths,
    language: projectInfo.language,
    otherPlugins: pluginConfigs,
    templateEngine: createTemplateEngine()
  };

  for (const plugin of enabledPlugins) {
    if (plugin.prompt) {
      const config = pluginConfigs.get(plugin.meta.name)!;

      try {
        const content = await plugin.prompt.generatePrompt(config, context);

        // Only include non-empty content
        if (content.trim()) {
          sections.push({
            sectionId: plugin.prompt.sectionId,
            sectionTitle: plugin.prompt.sectionTitle,
            content: content.trim(),
            priority: plugin.prompt.priority
          });
        }
      } catch (error) {
        logger.error(`Failed to generate prompt for plugin ${plugin.meta.name}:`, error);
        // Continue with other plugins
      }
    }
  }

  // 2. Sort sections by priority (ascending)
  sections.sort((a, b) => a.priority - b.priority);

  // 3. Assemble final CLAUDE.md
  let claudeMd = `# ${projectInfo.name}\n\n`;
  claudeMd += `${projectInfo.description}\n\n`;
  claudeMd += `---\n\n`;

  for (const section of sections) {
    claudeMd += section.content;
    claudeMd += `\n\n---\n\n`;
  }

  // 4. Add custom instructions section (user-editable)
  claudeMd += `## Custom Instructions\n\n`;
  claudeMd += `This section is reserved for user-specific instructions and guidelines.\n\n`;
  claudeMd += `You can add custom prompts, project-specific rules, or any other instructions here.\n`;

  return claudeMd;
}

/**
 * Create template engine with Handlebars-like syntax
 */
function createTemplateEngine(): TemplateEngine {
  return {
    render(template: string, variables: Record<string, any>): string {
      // Use Handlebars or similar template engine
      // Supports:
      // - {{variable}} - variable substitution
      // - {{#if condition}}...{{/if}} - conditionals
      // - {{#each array}}...{{/each}} - iteration
      // - {{#unless condition}}...{{/unless}} - negation

      const Handlebars = require('handlebars');
      const compiled = Handlebars.compile(template);
      return compiled(variables);
    }
  };
}
```

### File Writing

```typescript
/**
 * Write CLAUDE.md to disk
 */
async function writeCLAUDEmd(
  targetDir: string,
  content: string,
  baseDir: string = 'claude'
): Promise<void> {
  const claudeMdPath = path.join(targetDir, baseDir, 'CLAUDE.md');
  await fs.writeFile(claudeMdPath, content, 'utf-8');

  // Create symlink at project root (for convenience)
  const symlinkPath = path.join(targetDir, 'CLAUDE.md');
  const relativeTarget = path.join(baseDir, 'CLAUDE.md');

  try {
    await fs.unlink(symlinkPath); // Remove existing symlink
  } catch (error) {
    // Ignore if doesn't exist
  }

  await fs.symlink(relativeTarget, symlinkPath);
}
```

---

## Complete Examples

### Example 1: Minimal Configuration (Only Prompt Presets)

**Plugin Selection**:
- ‚úÖ Prompt Presets
- ‚ùå Memory System
- ‚ùå Git Integration
- ‚ùå System Detection

**Generated CLAUDE.md**:

```markdown
# My Simple Project

A minimal web application for learning purposes.

---

## Prompt Presets

This project has installed prompt presets for common development tasks. Each preset provides specialized instructions and guidelines.

### Installed Presets

- **[Code Review](claude/prompts/code-review.md)**: Guidelines for reviewing code changes
- **[Documentation](claude/prompts/documentation.md)**: Generate and maintain documentation

### Usage Guidelines

**When to use presets**:
- User explicitly requests the task (e.g., "Review this code", "Generate documentation")
- Task aligns with preset's scope and purpose

**How to use presets**:
1. User mentions task or preset name
2. Read the preset file: `/claude/prompts/{preset-filename}.md`
3. Follow the instructions and guidelines in the preset
4. Apply preset-specific formatting and quality standards

**Available preset categories**:
- **development**: Development and coding tasks
  - Code Review
- **documentation**: Documentation tasks
  - Documentation

**Note**: Presets are guidelines, not rigid rules. Adapt to specific context and user needs while maintaining quality standards.

---

## Custom Instructions

This section is reserved for user-specific instructions and guidelines.

You can add custom prompts, project-specific rules, or any other instructions here.
```

---

### Example 2: Full Configuration (All Plugins)

**Plugin Selection**:
- ‚úÖ System Detection
- ‚úÖ Git Integration (auto-commit enabled, remote sync enabled)
- ‚úÖ Memory System (all types)
- ‚úÖ Prompt Presets (3 presets)

**Generated CLAUDE.md**:

```markdown
# My Awesome Project

A comprehensive web application with full memory system and git integration.

---

## System Information

**Operating System**: Ubuntu (22.04)
**OS Type**: Linux

**Package Manager**: apt
**Install Prefix**: sudo

### Package Installation

When installing system packages or dependencies:

\```bash
sudo apt install <package>
\```

**Important Notes**:
- Use `apt` for package installation
- Sudo is available for privileged operations
- Running as non-root user

---

## Development Environment

### Python Development

**Version**: 3.11.5
**Package Manager**: uv
**Virtual Environment**: .venv

**Guidelines**:
- Use uv for package management
- Follow Python 3.11.5 syntax and features
- Virtual environment is already configured

### Node.js Development

**Version**: 20.10.0
**Package Manager**: pnpm

**Guidelines**:
- Use pnpm for package management
- Use `pnpm` to run scripts
- Follow Node.js 20.10.0 APIs

---

## Git Operations

### Auto-Commit Configuration

**Status**: ENABLED

Changes to Claude memory system files will be automatically committed after initialization.

- Memory system files (`claude/` directory) are committed **separately** from other changes
- This keeps memory updates isolated and easier to review

**Commit Message Format**:
```
chore: update memory system (config, prompts, memory)

Update Claude memory system configuration and files.

Date: 2025-01-18
Files updated: 5

Auto-generated commit by claude-memory-init.
```

### Remote Sync Configuration

**Status**: ENABLED

**Repository**: git@github.com:team/memory-template.git

System memory files can be synced to the remote repository.

- **Auto PR**: ENABLED - Pull requests are automatically created when syncing changes
- **PR Label**: `system-prompt-update`

**Synced Files**: Only `memory/system/` files (team-shared knowledge)
**Excluded**: `memory/semantic/`, `memory/episodic/`, `memory/procedural/` (project-specific)

### Git Ignore Configuration

The following patterns are automatically added to `.gitignore`:

- `claude/temp/`

---

### Git Rules for AI Agent

**AI Git Operations**: DISABLED

üö´ **ABSOLUTE PROHIBITION**: The AI Agent is **FORBIDDEN** from performing ANY git operations.

- ‚ùå No git commands (commit, push, pull, merge, rebase, etc.)
- ‚ùå No commit message generation
- ‚ùå No staging files with `git add`
- ‚ùå No suggestions to run git commands

**Rationale**: Version control is EXCLUSIVELY the user's responsibility.

When work is complete:
1. ‚úÖ Inform user: "Work complete. Files have been created/updated."
2. ‚úÖ List affected files
3. ‚ùå **DO NOT** offer to commit or suggest git commands

**The user will handle all git operations themselves.**

---

## Memory System

This project uses Claude's memory system to maintain context and knowledge across sessions through a structured memory architecture.

### Memory Types Enabled

- **semantic**: Stable knowledge and concepts
- **episodic**: Task history and temporal context
- **procedural**: Workflows and procedures

### Memory Structure

```
My Awesome Project/
‚îú‚îÄ‚îÄ claude/
‚îÇ   ‚îú‚îÄ‚îÄ memory/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ semantic/          # Stable knowledge and concepts
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ sem-NNN-*.md
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ episodic/          # Task history and temporal context
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ep-NNN-*.md
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ procedural/        # Workflows and procedures
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ proc-*.md
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ system/            # Team-shared templates and tools
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ tools/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index/             # Global indexes
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ tags.json
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ topics.json
```

### Memory-First Operating Principle

**MANDATORY WORKFLOW**: Every action must follow this sequence:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ PHASE 1: CONSULT MEMORY (BEFORE work)     ‚îÇ
‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ‚îÇ
‚îÇ 1. Read tags.json and topics.json         ‚îÇ
‚îÇ 2. Query for relevant knowledge           ‚îÇ
‚îÇ 3. Read semantic notes (stable knowledge) ‚îÇ
‚îÇ 4. Read episodic notes (history)          ‚îÇ
‚îÇ 5. Read procedural notes (workflows)      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
               ‚îÇ
               ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ PHASE 2: WORK (WITH memory as foundation) ‚îÇ
‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ‚îÇ
‚îÇ ‚úÖ Use memory knowledge as base           ‚îÇ
‚îÇ ‚úÖ Only read NEW code if memory lacking   ‚îÇ
‚îÇ ‚úÖ Create notes IMMEDIATELY on discovery  ‚îÇ
‚îÇ ‚ùå NEVER re-analyze what's in memory      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
               ‚îÇ
               ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ PHASE 3: UPDATE MEMORY (AFTER actions)    ‚îÇ
‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ‚îÇ
‚îÇ 1. Create/update semantic notes           ‚îÇ
‚îÇ 2. Create/update episodic notes           ‚îÇ
‚îÇ 3. Update indexes IMMEDIATELY             ‚îÇ
‚îÇ 4. Add cross-references                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Session Start Checklist

**ALWAYS do these at session start**:
- [ ] Read `/claude/memory/index/tags.json`
- [ ] Read `/claude/memory/index/topics.json`
- [ ] Read last 1-2 episodic notes
- [ ] Query and read relevant semantic notes
- [ ] Check for workflow procedures if task-specific

### Memory File Formats

**Semantic Memory**:
```markdown
---
id: sem-NNN
tags: [concept, architecture, api]
topics: [backend, database]
created: YYYY-MM-DD
updated: YYYY-MM-DD
---

# [Concept Name]

## Overview
[Stable, factual knowledge about this concept]

## Details
[Key facts, relationships, dependencies]

## References
- Related: [[sem-XXX]], [[sem-YYY]]
- Outputs: [[result/N/file.md#section]]
```

**Episodic Memory**:
```markdown
---
id: ep-NNN
date: YYYYMMDD
task: N
tags: [task-N, implementation, testing]
topics: [feature-X]
---

# Task N: [Task Name] - [Phase]

## Session Context
- **Started**: [timestamp]
- **Duration**: [time]
- **Phase**: [Planning/Implementation/Testing]

## Actions Taken
1. [What was done]
2. [Decisions made]

## Outcomes
- Files modified: [list]
- Key insights: [discoveries]

## Next Steps
- [ ] [What remains to be done]

## Cross-References
- Semantic: [[sem-XXX]]
- Outputs: [[result/N/output.md]]
```

**Procedural Memory**:
```markdown
---
id: proc-[name]
category: workflow
tags: [procedure, testing, deployment]
---

# [Workflow Name]

## When to Use
[Trigger conditions for this workflow]

## Steps
1. [Step 1]
2. [Step 2]
3. [Step 3]

## Inputs
- [Required inputs]

## Outputs
- [Expected outputs]

## Checkpoints
- [ ] [Critical validation points]
```

### Context Overflow Prevention

**CRITICAL**: Monitor context usage to prevent overflow.

- **Context >70%**: Prepare for checkpointing
- **Context >80%**: Checkpoint NOW

**Checkpointing Protocol**:
1. PAUSE current work immediately
2. Save ALL progress to episodic note
3. Update all indexes
4. Create "resume plan"
5. Inform user: "‚ö†Ô∏è Context at XX%. Saved to memory. Please run: /clear"
6. After /clear: Resume from checkpoint

### Memory Template Source

**Template**: default

For complete memory system documentation, see:
- `/claude/memory/DESIGN.md` - Architecture and design
- `/claude/memory/procedural/memory-first-workflow.md` - Detailed workflows
- `/claude/memory/procedural/memory-system-operations.md` - Operations guide

---

## Prompt Presets

This project has installed prompt presets for common development tasks. Each preset provides specialized instructions and guidelines.

### Installed Presets

- **[Code Review](claude/prompts/code-review.md)**: Guidelines for reviewing code changes
- **[Documentation](claude/prompts/documentation.md)**: Generate and maintain documentation
- **[Architecture](claude/prompts/architecture.md)**: Analyze system architecture

### Usage Guidelines

**When to use presets**:
- User explicitly requests the task (e.g., "Review this code", "Generate documentation")
- Task aligns with preset's scope and purpose

**How to use presets**:
1. User mentions task or preset name
2. Read the preset file: `/claude/prompts/{preset-filename}.md`
3. Follow the instructions and guidelines in the preset
4. Apply preset-specific formatting and quality standards

**Available preset categories**:
- **development**: Development and coding tasks
  - Code Review
- **documentation**: Documentation tasks
  - Documentation
  - Architecture

**Note**: Presets are guidelines, not rigid rules. Adapt to specific context and user needs while maintaining quality standards.

---

## Custom Instructions

This section is reserved for user-specific instructions and guidelines.

You can add custom prompts, project-specific rules, or any other instructions here.
```

---

### Example 3: Memory System + System Detector (No Git, No Presets)

**Plugin Selection**:
- ‚úÖ System Detection
- ‚ùå Git Integration
- ‚úÖ Memory System (semantic + episodic only)
- ‚ùå Prompt Presets

**Generated CLAUDE.md**:

```markdown
# Data Science Project

A machine learning project for data analysis and model training.

---

## System Information

**Operating System**: macOS (14.2)
**OS Type**: Darwin

**Package Manager**: brew

### Package Installation

When installing system packages or dependencies:

\```bash
brew install <package>
\```

**Important Notes**:
- Use `brew` for package installation
- Running as non-root user

---

## Development Environment

### Python Development

**Version**: 3.11.5
**Package Manager**: pip

**Guidelines**:
- Use pip for package management
- Follow Python 3.11.5 syntax and features
- Consider creating a virtual environment for isolation

---

## Memory System

This project uses Claude's memory system to maintain context and knowledge across sessions through a structured memory architecture.

### Memory Types Enabled

- **semantic**: Stable knowledge and concepts
- **episodic**: Task history and temporal context

### Memory Structure

```
Data Science Project/
‚îú‚îÄ‚îÄ claude/
‚îÇ   ‚îú‚îÄ‚îÄ memory/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ semantic/          # Stable knowledge and concepts
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ sem-NNN-*.md
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ episodic/          # Task history and temporal context
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ep-NNN-*.md
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ system/            # Team-shared templates and tools
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ tools/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index/             # Global indexes
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ tags.json
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ topics.json
```

### Memory-First Operating Principle

**MANDATORY WORKFLOW**: Every action must follow this sequence:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ PHASE 1: CONSULT MEMORY (BEFORE work)     ‚îÇ
‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ‚îÇ
‚îÇ 1. Read tags.json and topics.json         ‚îÇ
‚îÇ 2. Query for relevant knowledge           ‚îÇ
‚îÇ 3. Read semantic notes (stable knowledge) ‚îÇ
‚îÇ 4. Read episodic notes (history)          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
               ‚îÇ
               ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ PHASE 2: WORK (WITH memory as foundation) ‚îÇ
‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ‚îÇ
‚îÇ ‚úÖ Use memory knowledge as base           ‚îÇ
‚îÇ ‚úÖ Only read NEW code if memory lacking   ‚îÇ
‚îÇ ‚úÖ Create notes IMMEDIATELY on discovery  ‚îÇ
‚îÇ ‚ùå NEVER re-analyze what's in memory      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
               ‚îÇ
               ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ PHASE 3: UPDATE MEMORY (AFTER actions)    ‚îÇ
‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ‚îÇ
‚îÇ 1. Create/update semantic notes           ‚îÇ
‚îÇ 2. Create/update episodic notes           ‚îÇ
‚îÇ 3. Update indexes IMMEDIATELY             ‚îÇ
‚îÇ 4. Add cross-references                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Session Start Checklist

**ALWAYS do these at session start**:
- [ ] Read `/claude/memory/index/tags.json`
- [ ] Read `/claude/memory/index/topics.json`
- [ ] Read last 1-2 episodic notes
- [ ] Query and read relevant semantic notes

### Memory File Formats

**Semantic Memory**:
```markdown
---
id: sem-NNN
tags: [concept, architecture, api]
topics: [backend, database]
created: YYYY-MM-DD
updated: YYYY-MM-DD
---

# [Concept Name]

## Overview
[Stable, factual knowledge about this concept]

## Details
[Key facts, relationships, dependencies]

## References
- Related: [[sem-XXX]], [[sem-YYY]]
- Outputs: [[result/N/file.md#section]]
```

**Episodic Memory**:
```markdown
---
id: ep-NNN
date: YYYYMMDD
task: N
tags: [task-N, implementation, testing]
topics: [feature-X]
---

# Task N: [Task Name] - [Phase]

## Session Context
- **Started**: [timestamp]
- **Duration**: [time]
- **Phase**: [Planning/Implementation/Testing]

## Actions Taken
1. [What was done]
2. [Decisions made]

## Outcomes
- Files modified: [list]
- Key insights: [discoveries]

## Next Steps
- [ ] [What remains to be done]

## Cross-References
- Semantic: [[sem-XXX]]
- Outputs: [[result/N/output.md]]
```

### Context Overflow Prevention

**CRITICAL**: Monitor context usage to prevent overflow.

- **Context >70%**: Prepare for checkpointing
- **Context >80%**: Checkpoint NOW

**Checkpointing Protocol**:
1. PAUSE current work immediately
2. Save ALL progress to episodic note
3. Update all indexes
4. Create "resume plan"
5. Inform user: "‚ö†Ô∏è Context at XX%. Saved to memory. Please run: /clear"
6. After /clear: Resume from checkpoint

### Memory Template Source

**Template**: default

For complete memory system documentation, see:
- `/claude/memory/DESIGN.md` - Architecture and design
- `/claude/memory/procedural/memory-first-workflow.md` - Detailed workflows
- `/claude/memory/procedural/memory-system-operations.md` - Operations guide

---

## Custom Instructions

This section is reserved for user-specific instructions and guidelines.

You can add custom prompts, project-specific rules, or any other instructions here.
```

---

## Implementation Guidelines

### For Plugin Developers

When implementing prompt contribution for your plugin:

1. **Create prompt template file** in your plugin directory:
   ```
   plugins/your-plugin/templates/prompt.md.template
   ```

2. **Implement PluginPromptContributor**:
   ```typescript
   export const yourPluginPrompt: PluginPromptContributor = {
     sectionId: 'your-section',
     sectionTitle: 'Your Section Title',
     priority: 50,  // Choose appropriate priority

     generatePrompt: async (config, context) => {
       const template = await loadTemplate('prompt.md.template');
       const variables = {
         your_plugin: config.options,
         paths: context.paths,
         // ... other variables
       };
       return context.templateEngine.render(template, variables);
     }
   };
   ```

3. **Add to plugin definition**:
   ```typescript
   export const yourPlugin: Plugin = {
     meta: { /* ... */ },
     configuration: { /* ... */ },
     hooks: { /* ... */ },
     prompt: yourPluginPrompt  // Add here
   };
   ```

4. **Test with different configurations**:
   - Minimal config (plugin disabled)
   - Default config
   - Full config with all options

### For Core Developers

When implementing the CLAUDE.md generation system:

1. **Template Engine Setup**:
   - Use Handlebars or compatible engine
   - Register custom helpers if needed
   - Support partial templates

2. **Error Handling**:
   - Gracefully handle missing variables
   - Log errors but continue with other plugins
   - Provide clear error messages

3. **Performance**:
   - Cache compiled templates
   - Parallelize plugin prompt generation
   - Lazy-load template files

4. **Testing**:
   - Unit test each plugin's prompt generation
   - Integration test final CLAUDE.md assembly
   - Test all combinations of plugins

---

## Migration from v1.x

### Old System (v1.x)

Single monolithic template:
```
mem/CLAUDE.md.template
```

All content in one file, rendered once.

### New System (v2.0)

Modular plugin-based templates:
```
plugins/system-detector/templates/prompt.md.template
plugins/git/templates/prompt.md.template
plugins/memory-system/templates/prompt.md.template
plugins/prompt-presets/templates/prompt.md.template
```

Each plugin contributes its own section.

### Migration Strategy

1. **Keep v1.x template** for backward compatibility
2. **New projects** use v2.0 plugin-based generation
3. **Existing projects** can opt-in to v2.0 via `--force` re-initialization
4. **Auto-detect** old CLAUDE.md format and offer migration

---

## Summary

### Key Benefits

1. **Modularity**: Each plugin owns its prompt section
2. **Flexibility**: Users choose which plugins (and sections) to enable
3. **Maintainability**: Update plugin prompts independently
4. **Extensibility**: New plugins easily add sections
5. **Clarity**: Clear structure and ordering

### Implementation Checklist

For plugin developers:
- [ ] Create prompt template file
- [ ] Implement PluginPromptContributor
- [ ] Define variables and conditional blocks
- [ ] Add to plugin definition
- [ ] Test with various configurations

For core implementation:
- [ ] Implement template engine integration
- [ ] Create CLAUDE.md generation function
- [ ] Add prompt collection from plugins
- [ ] Implement section ordering by priority
- [ ] Add error handling and logging
- [ ] Write comprehensive tests
- [ ] Update documentation

---

**Document Version**: 1.0.0
**Last Updated**: 2025-01-18
**Status**: Ready for Implementation
